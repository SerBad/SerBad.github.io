---
title: 多模块下的页面跳转
tags: Android
comments: false
date: 2020-11-25 18:01:14
---
在多模块下或者组件化下，页面跳转是比较麻烦处理的一个地方，下面记录一下跳转的方法。以下应用包名统一用``com.android.demo``来指代。
<!--more-->
# BroadcastReceiver
使用广播是最简单的办法，可以通过注册广播来处理页面跳转。需要注意的是，从7.0开始广播开始受到限制，对于应用广播，可以用以下方法，到10.0及以下都是可以在多种机型上可以的。同样的，也可以用Activity来处理。基本逻辑是一样的，这里不再赘述。
在AndroidManifest.xml，``permission ``和``uses-permission``都是必须的：
```xml
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    package="com.android.demo"
    tools:ignore="LockedOrientationActivity">
    ...
    <permission android:name="com.android.demo.broadcast.PageReceiver.permission"
        android:protectionLevel="signature" />

    <uses-permission android:name="com.android.demo.broadcast.PageReceiver.permission" />
    <application>
      ...
      <receiver
            android:name=".broadcast.PageReceiver"
            android:enabled="true"
            android:exported="false"
            android:permission="com.android.demo.broadcast.PageReceiver.permission">
            <intent-filter>
                <action android:name="com.android.demo.broadcast.PageReceiver" />
            </intent-filter>
        </receiver>
    </application>

</manifest>

```
定义一些公有的参数来处理跳转
```Kotlin
import android.content.ComponentName
import android.content.Context
import android.content.Intent

object PageConstants {
    const val pageReceiver = "com.android.demo.broadcast.PageReceiver"
    const val pagePackage = "com.android.demo"
    const val pageReceiverPermission = "com.android.demo.broadcast.PageReceiver.permission"

    //我这里需要跳转的页面不多，所以在采用特定值的方式
    const val gotoVipPage = "gotoVipPage"

    @JvmStatic
    fun gotoVipPage(context: Context) {
        val intent = Intent(pageReceiver)
        //带上你要传递的参数，加上去就可以了
        intent.putExtra(PageConstants.gotoVipPage, PageConstants.gotoVipPage)
        //这个是必须添加的，为了在小米等手机上执行
        intent.component = ComponentName(pagePackage, pageReceiver)
        //pageReceiverPermission使用在AndroidManifest中注册的permission
        context.sendBroadcast(intent, PageConstants.pageReceiverPermission)
    }
}
```

``PageReceiver``中的实现
```Kotlin
import android.content.BroadcastReceiver
import android.content.Context
import android.content.Intent
import cc.fotoplace.PageConstants

class PageReceiver : BroadcastReceiver() {
    override fun onReceive(context: Context, intent: Intent) {
        when {
            //在这里处理参数
            intent.hasExtra(PageConstants.gotoVipPage) -> {
                val intentActivity = Intent(context, VipInfoActivity::class.java)
                intentActivity.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                context.startActivity(intentActivity)
            }
        }
    }
}
```

# 通过反射类名来跳转
通过反射可以直接去跳转页面，或者处理你要处理的方法
```Kotlin
import android.content.Context
import android.content.Intent
import android.util.Log

object PageConstants {
    @JvmStatic
    fun gotoVipPage(context: Context) {
        try {
            val intentActivity =
                Intent(context, Class.forName("com.android.demo.VipInfoActivity"))
            intentActivity.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
            if (intentActivity.resolveActivity(context.packageManager) != null) {
                context.startActivity(intentActivity)
            } else {
                Log.i("xx", "无法处理该跳转")
            }
        } catch (e: ClassNotFoundException) {
            e.printStackTrace()
            Log.i("xx", "找不到该页面")
        }
    }
}
```

以上方法，对于结果的回调，需要自己处理onActivityResult的方法来处理。

在这里提及一点儿需要注意的地方，对于文件、图片什么的，可以通过``ContentResolver``来处理传送的路径，并不需要直接发送文件。
```Kotlin
    // Add the image to media store.
    fun addImage(
        resolver: ContentResolver, title: String,
        date: Long, orientation: Int,
        path: String?
    ): Uri? {
        // Insert into MediaStore.
        val values = ContentValues(6)
        values.put(MediaStore.Images.ImageColumns.TITLE, title)
        values.put(MediaStore.Images.ImageColumns.DISPLAY_NAME, "$title.jpg")
        values.put(MediaStore.Images.ImageColumns.DATE_TAKEN, date)
        values.put(MediaStore.Images.ImageColumns.MIME_TYPE, "image/jpeg")
        values.put(MediaStore.Images.ImageColumns.ORIENTATION, orientation)
        values.put(MediaStore.Images.ImageColumns.DATA, path)
        var uri: Uri? = null
        try {
            uri = resolver.insert(
                MediaStore.Images.Media.EXTERNAL_CONTENT_URI,
                values
            )
        } catch (th: Throwable) {

        }
        return uri
    }
```
# [Deep link](https://developer.android.google.cn/training/app-links/deep-linking)
在``AndroidManifest``中注册一个DeepLinkActivity
```xml
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    package="com.android.demo"
    tools:ignore="LockedOrientationActivity">
    ...
    <application>
      ...
        <activity
            android:name=".DeepLinkActivity"
            android:theme="@android:style/Theme.NoDisplay">
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />

                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />

                <data android:scheme="route" android:host="open.my.app"/>
            </intent-filter>
         </activity>
    </application>

</manifest>
```
接受的DeepLinkActivity，在这里接收你要的数据，然后去处理即可
```kotlin
class DeepLinkActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        val action = intent?.action
        val scheme = intent?.data
        val value = intent?.getStringExtra(PageConstants.gotoVipPage)
    }
}
```
发送的方法
```kotlin
import android.content.Context
import android.content.Intent
import android.net.Uri
import android.util.Log

object PageConstants {
    const val gotoVipPage = "gotoVipPage"

    @JvmStatic
    fun gotoVipPage(context: Context) {
        val intent = Intent(Intent.ACTION_VIEW)

        intent.data = Uri.parse("route://open.my.app")
        intent.putExtra(gotoVipPage, gotoVipPage)
        if (intent.resolveActivity(context.packageManager) != null) {
            context.startActivity(intent)
        } else {
            Log.i("xx", "不支持该跳转")
        }
    }
}
```



# 其他的一些库
上面只是介绍了一些基本的原理，如果你懒的封装，也可以直接用别人的库，根据自己的需要酌情选择就是了，比如[ARouter]([https://github.com/alibaba/ARouter](https://github.com/alibaba/ARouter)
)，[Airbnb DeepLinkDispatch]([https://github.com/airbnb/DeepLinkDispatch](https://github.com/airbnb/DeepLinkDispatch)
)
